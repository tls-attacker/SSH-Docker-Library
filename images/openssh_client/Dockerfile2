FROM debian-build:bullseye AS openssh-builder
ARG VERSION
RUN curl -s https://cloudflare.cdn.openbsd.org/pub/OpenBSD/OpenSSH/portable/openssh-${VERSION}.tar.gz | tar xzf -

WORKDIR /src/openssh-${VERSION}
RUN ./configure --prefix /install
RUN make
RUN make install

FROM debian:bullseye AS openssh-client
ARG VERSION
RUN adduser --system --no-create-home sshd \
  && mkdir -p /var/empty \
  && (echo bydahirsch; echo bydahirsch) | adduser sshattacker --ingroup users
RUN apt-get update && apt-get install -y \
  libssl-dev \
  zlib1g-dev \
  expect \
  && rm -rf /var/lib/apt/lists/*
COPY --from=openssh-builder /install /install
LABEL "ssh_implementation"="openssh"
LABEL "ssh_implementation_version"="${VERSION}"
LABEL "ssh_implementation_connectionRole"="client"
COPY --from=entrypoint /bin/client-entrypoint /usr/local/bin/
COPY login.exp /usr/local/bin/
COPY start.sh /usr/local/bin/
WORKDIR /usr/local/bin/
ENTRYPOINT ["client-entrypoint", "./start.sh"]